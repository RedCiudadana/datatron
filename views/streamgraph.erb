<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var data, samples;
var beginning, ending;
var nest = d3.nest().key(function(d) { return d.category; });

function visualizeit() {
  // Setup data
  beginning = _.min(data, function(o) { return o.day }).day,
  ending    = _.max(data, function(o) { return o.day }).day;
  var maxCount = _.max(data, function(o) { return o.count }).count;
  var layers = nest.entries(data);
  samples = _.max(layers, function(layer) { return layer.values.length }).values.length;
  layers = fillMissingDays(layers);

  // Setup style and layout
  var width = document.body.clientWidth,
      height = 500,
      color = d3.scale.linear().range(["#aad", "#556"]);

  // Setup graph
  var x = d3.scale.linear()
        .domain([beginning, ending])
        .range([0, width]),
      y = d3.scale.linear()
        .domain([0, maxCount])
        .range([0, height/2]);

  var stack = d3.layout.stack()
        .offset("wiggle")
        .values(function(d) { return d.values })
        .x(function(d) { return d.day })
        .y(function(d) { return d.count });

  var area = d3.svg.area()
    .x(function(d)  { return x(d.day) })
    .y0(function(d) { return y(d.y0) })
    .y1(function(d) { return y(d.y0 + d.y) });

  var svg = d3.select("#graph").append("svg")
        .attr("width", width)
        .attr("height", height);

  svg.selectAll("path")
      .data(stack(layers))
      .enter().append("path")
      .attr("d", function(d) { return area(d.values) })
      .style("fill", function() { return color(Math.random()) });
};

d3.json("/daily.json", function(error, json) {
  if (error) return console.warn(error);
  data = json;
  visualizeit();
});

function fillMissingDays(layers) {
  _.each(layers, function(layer) {
    var rangeOfDays = _.range(beginning, ending + 1);
    var daysInLayer = _.pluck(layer.values, 'day');
    var missingDays = _.difference(rangeOfDays, daysInLayer);
    _.each(missingDays, function(day) {
      layer.values.push({ category: _.last(layer.values).category, count: 0, day: day });
    });
    layer.values = _.sortBy(layer.values, function (value) { return value.day });
  });

  return layers;
}

</script>

